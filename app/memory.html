<!DOCTYPE html>
<meta charset="utf-8">
<style>
.node {
    stroke: black;
    stroke-width: 0;
}

.link {
    stroke: lightgray;
    stroke-width: 1px;
}

body {
    font-family: Calibri;
    font-size: 12px;
    color: black;
}

svg {
    border: 1px solid black;
    width: 100%;
    height: 100%;
}

#score {
    position: absolute;
    top: 3px;
    left: 3px;
}

#hints {
    position: absolute;
    top: 3px;
    left: 20px;
}

#selection {
    position: absolute;
    top: 3px;
    right: 2px;
}

#container {
    position: relative;
    display: inline-block;
    height: 300px;
    width: 500px;
}

#message {
    position: absolute;
    bottom: 2px;
    left: 3px;
}

#restart {
    position: absolute;
    bottom: 2px;
    right: 2px;
}

.next {
    font-weight: bold;
}

</style>
<body>
    <div id="container"><svg>
        <div id="score">?</div>
        <div id="hints">
            <button id="sayit" onclick="gameManager('sayit');">Say It</button>&nbsp;
            <button id="showit" onclick="gameManager('showit');">Show It</button>&nbsp;
            <button id="boldit" onclick="gameManager('boldit');">Bold It</button>
        </div>
        <select id="selection" onchange="newText(value);">
            <option value="Gettysburg Address">Gettysburg Address</option>
            <option value="Constitution Preamble">Constitution Preamble</option>
            <option value="Williams Shedd">Williams Shedd</option>
            <option value="Ephesians 2:8">Ephesians 2:8</option>
            <option value="John 3:16">John 3:16</option>
            <option selected="selected" value="2 Timothy 4:7">2 Timothy 4:7</option>
        </select>
            <div id="message"><b>Memorizinator</b> (A little game to help you learn big ideas.)</div>
        <button id="restart" onclick="gameManager('restart');">Restart</button>
    </svg></div>
</body>

<script src="//d3js.org/d3.v4.js"></script>
<script>
    // TODO:
    // TODO: Unravelable (double-click undoes)
    // TODO: Hints: words (I h___ f______ t__), highlighting, speaker

    // General variablees
    var prevClicked = -1,   // ID of the most recent gnode that was clicked
        allWordData = [],   // All words (data) from text from json
        wordData = [],      // Words loaded (data) into simulation from json
        wordLinks = [],     // Links (data) in the simulation
        w = 500,            // Width of the svg palette
        h = 300,            // Height of the svg palette
        rad = 20,           // Radius of the word circles
        initCount = 7,      // Number of words to show at beginning of game
        answerKey = [],     // The right answer
        playerAnswer = [],  // 
        foci = [{ x: 100, y: h / 2 }, { x: 350, y: h / 2 }],
        defCitation = "2 Timothy 4:7",
        text,
        boldIt = false;

    // Get svg handle, set up color and radius scale
    var svg = d3.select("svg");
    var color = d3.scaleOrdinal().domain(0, 6)
        .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);
    var radScale = d3.scaleLinear().domain([1, 15]).range([10, 50]);

    // Set forces in the simulation
    var simulation = d3.forceSimulation()
        .force("link", d3.forceLink().id(function (d) { return d.id; }))
        .force("charge", d3.forceManyBody().strength(-50))
        .force("collide", d3.forceCollide(function (d) { return d.rad; }));

    // Define the 
    var glinks,         // Active links on the game
        gnodes;         // The current set of gnodes

    // Get text from json, then start simulation
    function build(citation) {
        d3.json("/data/texts.json", function (error, textsData) {

            // Get correct text and split
            var keyText = textsData.nodes.filter(function (obj) { if (obj.cit == citation) return true; else return false; });
            text = keyText[0].text;
            var kt = text.replace("-", "- ").split(" ");

            // 
            for (i = 0; i < kt.length; i++) {
                var firstIndex = kt.indexOf(kt[i]);
                var firstID = firstIndex > -1 ? Math.min(firstIndex, i) : i;
                answerKey.push(firstID);

                allWordData.push({
                    word: kt[i],
                    id: i,
                    wordid: firstID,
                    x: 0,
                    y: ~~(Math.random() * h),
                    rad: radScale(kt[i].length),
                    show: 0,
                    answerSet: 0
                })
            }

            // 
            for (i = 0; i < Math.min(initCount, allWordData.length) ; i++) {
                allWordData[i].show = 1;
                wordData.push(allWordData[i]);
            }

            for (i = 0; i < textsData.links.length ; i++) {
                wordLinks.push(textsData.links[i]);
            }

            gameManager("start");
            start();
        });
    }
    build(defCitation);


    // 
    function start() {

        // Create links
        glinks = svg.selectAll(".link")
            .data(wordLinks, function (d) { return d.source.id + "-" + d.target.id; })
            .enter().insert("line", ".gnode").attr("class", "link");
        glinks.exit().remove();

        // Create nodes (well, g-elements).  Add circles, text, & event listeners
        gnodes = svg.selectAll("g")
            .data(wordData, function id(d, i) { return d.id; })
            .enter().append("g").attr("class", function (d) { return "gnode g" + d.id; })
            .classed("next", function (d) { return (boldIt && d.wordid == 0) ? true : false ; });
        gnodes.exit().remove();

        var circles = gnodes.append("circle").attr("class", function (d) { return "c" + d.id; })
            .attr("r", function (d) { return d.rad; }).style("fill", function (d, i) { return color(d.id); })
            .attr("opacity", 0.7);

        var texts = gnodes.append("text")
            .attr("text-anchor", "middle")
            .attr("alignment-baseline", "central")
            .attr("class", function (d) { return "text w" + d.id; })
            .style("pointer-events", "none")
            .text(function (d) { return (d.word); });

        var actions = gnodes.on("dblclick", nodeClicked)
            .call(d3.drag()
                .on("start", dragStarted)
                .on("drag", dragged)
                .on("end", dragEnded));

        // Link data to simulation and set it in motion.
        simulation.nodes(wordData)
            .force("link").links(wordLinks);

        simulation.on("tick", ticked)
            .alpha(0.5)
            .restart();
    }


    function ticked(e) {
        var k = .2 * simulation.alpha();

        svg.selectAll(".gnode").attr("transform", function (d) {
            // Set node location, multi-foci
            d.y += (foci[d.answerSet].y - d.y) * k;
            d.x += (foci[d.answerSet].x - d.x) * k;

            // But be sure that they don't go out-of-bounds
            d.y = Math.max(d.rad, Math.min(h - d.rad, d.y));
            d.x = Math.max(d.rad, Math.min(w - d.rad, d.x));

            return 'translate(' + [d.x, d.y] + ')';
        });

        // Set link locations
        svg.selectAll(".link")
            .attr("x1", function (d) { return d.source.x; })
            .attr("y1", function (d) { return d.source.y; })
            .attr("x2", function (d) { return d.target.x; })
            .attr("y2", function (d) { return d.target.y; });
    }

    function dragStarted(d) {
        d3.select(this).raise().classed("active", true);
        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function dragged(d) {
        d3.select(this).attr("cx", d.x = d3.event.x).attr("cy", d.y = d3.event.y);
        d.fx = d3.event.x;
        d.fy = d3.event.y;
    }

    function dragEnded(d) {
        d3.select(this).classed("active", false);
        if (!d3.event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }

    function nodeClicked(d) {

        // Move the node, and a link
        d.answerSet = 1;
        if (allWordData.length > wordData.length) {
            allWordData[wordData.length].show = 1;
            wordData.push(allWordData[wordData.length]);
        }

        if (prevClicked != -1) { wordLinks.push({ "source": prevClicked, "target": d.id }); }
        start();

        // Update prevClicked and check the answer
        prevClicked = d.id;
        playerAnswer.push(d.wordid);
        svg.selectAll(".text").classed("next", function (d) { return (boldIt && d.wordid == answerKey[playerAnswer.length]) ? true : false; });
        if (playerAnswer.toString() == answerKey.toString()) { gameManager("win"); }
        else if (playerAnswer.toString() != answerKey.slice(0, playerAnswer.length).toString()) { gameManager("incorrect"); }
    }

</script>
<script>

    var score = document.getElementById("score"),
        message = document.getElementById("message"),
        timer,
        timerLength = 20;

    function gameManager(event) {
        
        switch (event) {
            case "incorrect":
                message.innerHTML = "<b>There's a problem...</b>";
                break;
            case "start":
                timerLength = ~~(allWordData.length * 1.5);
                clearInterval(timer);
                timer = setInterval(gameTimer, 1000);
                message.innerHTML = "";
                score = document.getElementById("hints").style.visibility = "visible";
                break;
            case "win":
                message.innerHTML = "<b>You WON! Score = " + timerLength + "</b>";
                clearInterval(timer);
                break;
            case "loss":
                message.innerHTML = "I'm sorry for your loss.";
                clearInterval(timer);
                break;
            case "restart":
                var sel = document.getElementById("selection");
                newText(sel.options[sel.selectedIndex].text);
                break;
            case "sayit":
                var msg = new SpeechSynthesisUtterance(text);
                window.speechSynthesis.speak(msg);
                break;
            case "boldit":
                boldIt = !boldIt;
                break;
            case "showit":
                if (message.innerHTML == text) { message.innerHTML = ""; }
                else { message.innerHTML = text; }
                break;

        }

        // change chooser to hinter
        // watch for new game messages
        // announce win / score or loss
    }


    function gameTimer() {
            if (timerLength >= 0) {
                score.innerHTML = timerLength--;
            } else {
                gameManager("loss")
                clearInterval(timer);
            }
    }


    function newText(newValue) {

        prevClicked = -1;   // ID of the most recent gnode that was clicked
        allWordData = [];   // All words (data) from text from json
        wordData = [];      // Words loaded (data) into simulation from json
        wordLinks = [];     // Links (data) in the simulation
        answerKey = [];     // The right answer
        playerAnswer = [];  //

        d3.selectAll("svg > *").remove();
        start();
        build(newValue);
    }


</script>
