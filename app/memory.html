<!DOCTYPE html>
<meta charset="utf-8">
<title>Memorizinator</title>
<link rel="stylesheet" href="/resource/SkinnySkeleton.css" type="text/css" media="screen" /> 
<style>

    @import url(http://weloveiconfonts.com/api/?family=entypo);
    [class*="entypo-"]:before { /* entypo */
        font-family: 'entypo', sans-serif; }

     #container {
        position: relative;
        display: inline-block;
        height: 400px;
        width: 700px; }

   #gameboard {
        border: 1px solid #840000;
        position: relative;
        width: 100%;
        height: 100%; }

    .node {
        stroke: black;
        stroke-width: 0;
        position: relative; }

    .text { /* centers text in node */
        text-anchor: middle;
        alignment-baseline: central;
        pointer-events: none;
        transform: translateY(1%); /* Firefox */
    }

    .next { /* for boldIt hint */
        font-weight: bold; }

    .link {
        stroke: lightgray;
        stroke-width: 1px; }

    #selectText {
        position: absolute;
        top: 3px;
        right: 2px; }

    #message {
        position: absolute;
        bottom: 2px;
        left: 3px; }

    #restart {
        position: absolute;
        bottom: 2px;
        right: 4px; }

    #settings {
        position: absolute;
        bottom: 2px;
        right: 24px; }

    #typeit {
        position: absolute;
        bottom: 2px;
        right: 48px; }

    .popup {
	    display: none;
	    position: absolute;
        line-height: 200%;
        padding: 2%;
        border: 1px solid #840000;
	    background-color: white;
	    z-index: 1002;
	    overflow: auto;
        box-shadow: -10px 0 0 100em rgba(209, 200, 208, .6);
    }

    #setsPop {
        left: 15%;
        top: 20%;
        width: 66%;
        height: 40%;
    }

    #typePop {
        top: 2%;
        left: 2%;
        width: 92%;
        height: 88%;
    }

    #timerBar {
        fill: #840000;
        opacity: 0.7; }
    #timerBarBox {
        fill: #e0e0e2; }

</style>
<body>
    <div id="container">
        <svg id="gameboard">
            <rect width="0" height="10" x="3" y="3" id="timerBarBox"></rect>
            <rect width="0" height="10" x="3" y="3" id="timerBar"></rect>
            <div></div>
        </svg>

        <select id="selectText"></select>
        <div id="message"><b>Memorizinator</b> (A little game to help you learn big ideas.)</div>

        <span id="settings" class="entypo-tools iconButton" title="Show Settings"></span>
        <span id="restart" class="entypo-arrows-ccw iconButton" title="Restart round"></span>
        <span id="typeit" class="entypo-keyboard iconButton" title="Type it"></span>
        <div id="setsPop" class="popup"> 
            <div class="row">
                <div class="eleven columns"><h5>Settings</h5></div>
                <div class="iconButton close one columns entypo-cancel" id="setsPopClose"></div>
            </div>
            <hr />
            <div class="row">
                <div class="button four columns" id="sayit" title="Reads the text to you. Click again to silence.">Say It</div>
                <div class="button four columns" id="showit" title="Show the text inthe lower corner. Click again to hide.">Show It</div>
                <div class="button four columns" id="boldit" title="Bold the next word you need to click. Click again to turn off.">Bold It</div>
            </div>
        </div>
        <div id="typePop" class="popup">
            <div class="row">
                <div class="eleven columns"><h5 id="typeCitation"></h5></div>
                <div class="iconButton close one columns entypo-cancel"></div>
            </div>
            <hr />
            <div class="row">
                <h4 id="typeText" contenteditable="true"></h4>
            </div>
        </div>
    </div>
</body>
<script src="//d3js.org/d3.v4.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script>
    $(function () {

        // ********** EVENTS **********
        $("body").click(function () {
            //$('.popup:visible').hide();
        });

        $("#selectText").change(function () {
            citation = $("#selectText").val();
            gameManager('restart');
        });

        $("#typeit").click(function () {
            $('#typePop').show();
            typer();
        });

        $("#settings").click(function () { $('#setsPop').show(); });
        $("#restart").click(function () { gameManager('restart'); });

        $("#sayit").click(function () { gameManager('sayit'); });
        $("#showit").click(function () { gameManager('showit'); });
        $("#boldit").click(function () { gameManager('boldit'); });
        $(".close").click(function () { $('.popup:visible').hide(); });


        // ********** D3 HAPPENS HERE **********
        // General variablees
        var allWordData = [],   // All words (data) from text from json
            wordData = [],      // Words loaded (data) into simulation from json
            wordLinks = [],     // Links (data) in the simulation
            svgWidth = 700,     // Width of the svg palette
            svgHeight = 400,    // Height of the svg palette
            initCount = 7,      // Number of words to show at beginning of game
            answerKey = [],     // An array of wordID's indicating the correct answer
            playerAnswer = [],  // An array of wordID's indicating the player's answer
            clickedID = [],     // An array of the players answers
            foci = [{ x: svgWidth * 0.25, y: svgHeight * 0.45 }, { x: svgWidth * 0.75, y: svgHeight * 0.45 }], // Sets 2 foci on page
            citation = "Williams Shedd",
            text,               // The text to be memorized
            boldIt = false,     // Is the boltIt hint be active?
            color;              // Node colors

        // Get svg handle, set up color and radius scale (use word length to set size)
        var svg = d3.select("svg");
        var radScale = d3.scaleLinear().domain([1, 15]).range([10, 50]);

        // Set forces in the simulation
        var simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(function (d) { return d.id; }))
            .force("charge", d3.forceManyBody().strength(-50))
            .force("collide", d3.forceCollide(function (d) { return d.rad; }));

        // Get text from json, then start simulation
        function build() {
            d3.json("/data/texts.json", function (error, textsData) {

                // Populate dropdown if it's empty
                dd = document.getElementById("selectText");
                if (dd.options.length == 0) {
                    for (var i = 0; i < textsData.nodes.length; i++) {
                        var el = document.createElement("option");
                        el.textContent = el.value = textsData.nodes[i].cit; // set text and value
                        el.selected = (textsData.nodes[i].cit == citation); // select 
                        dd.appendChild(el);
                    }
                }

                // Get and split requested text and split, save text for later use.
                var keyText = textsData.nodes.filter(function (obj) { if (obj.cit == citation) return true; else return false; });
                text = keyText[0].text;
                var kt = text.replace("-", "- ").split(" ");


                // Format data, create answerkey
                for (i = 0; i < kt.length; i++) {
                    var firstIndex = kt.indexOf(kt[i]);
                    var firstID = firstIndex > -1 ? Math.min(firstIndex, i) : i;
                    answerKey.push(firstID);

                    allWordData.push({
                        word: kt[i],
                        id: i,
                        wordid: firstID, // identical words have the same wordid
                        x: 0,
                        y: ~~(Math.random() * svgHeight),
                        rad: radScale(kt[i].length),
                        clickOrder: 0,  // for later use?
                        answerSet: 0    // for later use?
                    })
                }
                color = d3.scaleOrdinal().domain(0, 4).range(colorPalette(text.length));


                // Push word data into active dataset
                for (i = 0; i < Math.min(initCount, allWordData.length) ; i++) {
                    allWordData[i].show = 1;
                    wordData.push(allWordData[i]);
                }

                // for (i = 0; i < textsData.links.length ; i++) { wordLinks.push(textsData.links[i]); }

                gameManager("start");
                start();
            });
        }
        build();


        // Build the force simulation
        function start() {

            // Create links
            var glinks = svg.selectAll(".link")
                .data(wordLinks, function (d) { return d.source.id + "-" + d.target.id; })
                .enter().insert("line", ".gnode").attr("class", "link");
            //glinks.exit().remove();

            // Create nodes (well, g-elements).  Add circles, text, & event listeners
            var gnodes = svg.selectAll("g")
                .data(wordData, function id(d, i) { return d.id; })
                .enter().append("g").attr("class", function (d) { return "gnode g" + d.id; })
                .classed("next", function (d) { return (boldIt && d.wordid == 0) ? true : false ; });
            //gnodes.exit().remove();

            var circles = gnodes.append("circle").attr("class", function (d) { return "c" + d.id; })
                .attr("r", function (d) { return d.rad; }).style("fill", function (d, i) { return color(d.id); })
                .attr("opacity", 0.7);

            var texts = gnodes.append("text")
                .attr("class", function (d) { return "text w" + d.id; }) // Tie into CSS
                .text(function (d) { return (d.word); });

            var actions = gnodes.on("click", nodeClicked);

            // Link data to simulation and set it in motion.
            simulation.nodes(wordData).force("link").links(wordLinks);
            simulation.on("tick", ticked).alpha(0.5).restart();
        }

        // Manage node & link movement
        function ticked(e) {
            var k = .2 * simulation.alpha();

            svg.selectAll(".gnode").attr("transform", function (d) {
                // Set node location, multi-foci
                d.y += (foci[d.answerSet].y - d.y) * k;
                d.x += (foci[d.answerSet].x - d.x) * k;

                // But be sure that nodes don't go out-of-bounds
                d.y = Math.max(d.rad, Math.min(svgHeight - d.rad, d.y));
                d.x = Math.max(d.rad, Math.min(svgWidth - d.rad, d.x));

                return 'translate(' + [d.x, d.y] + ')';
            });

            // Set link locations
            svg.selectAll(".link")
                .attr("x1", function (d) { return d.source.x; })
                .attr("y1", function (d) { return d.source.y; })
                .attr("x2", function (d) { return d.target.x; })
                .attr("y2", function (d) { return d.target.y; });
        }

        // User clicked a node
        function nodeClicked(d) {
            if (d.answerSet == 0) {
                d.answerSet = 1; // Moves the gnode over to the answer side.
                if (allWordData.length > wordData.length) {
                    allWordData[wordData.length].show = 1;
                    wordData.push(allWordData[wordData.length]); // Gets the next word.
                }

                // Add a link between last clicked and new clicked
                if (clickedID.length > 0) { wordLinks.push({ "source": clickedID.slice(-1)[0], "target": d.id }); }
                start();

                // Update clickedID and check the answer
                clickedID.push(d.id);
                playerAnswer.push(d.wordid);    // Update the players answer
                svg.selectAll(".text")          // Bold next word
                    .classed("next", function (d) { return (boldIt && d.wordid == answerKey[playerAnswer.length]) ? true : false; });
                if (playerAnswer.toString() == answerKey.toString()) { gameManager("win"); } // Check answer or error
                else if (playerAnswer.toString() != answerKey.slice(0, playerAnswer.length).toString()) { gameManager("incorrect"); }
            } else {   // d.answerSet == 1
                d.answerSet == 0;
                for (var i = clickedID.length - 1; i >= 0; i--) {
                    id = clickedID[i];
                    d3.select(".g" + id + " > .c" + id).attr("opacity", 1);
                    findLinks(id)
                    if (id == d.id) break;
                }
                start();
                // reset foci
                // mark as answer = false

            }
        }

        function findNode(id) {

        }

        function findLinks(id) {
            for (var i = 0; i < wordLinks.length; i++) {
                if (id == wordLinks[i].source["id"] || id == wordLinks[i].target["id"]) {
                    //alert(id);
                }

                //if (clickedID[i] == d.id) break;
            }
        }

        function colorPalette(id) {
            var palettes = [["#3dc8ff", "#ff3d87", "#ff703d", "#ffc83d", "#e1ff3d"],
                ["#493548", "#4b4e6d", "#6a8d92", "#80b192", "#a1e887"],
                ["#335c67", "#fff3b0", "#e09f3e", "#9e2a2b", "#540b0e"],
                ["#4d9de0", "#e15554", "#e1bc29", "#3bb273", "#7768ae"],
                ["#202030", "#39304a", "#635c51", "#7d7461", "#b0a990"],
                ["#f1e0c5", "#c9b79c", "#71816d", "#342a21", "#da667b"],
                ["#7b7554", "#17183b", "#a11692", "#ff4f79", "#ffb49a"]];
            return palettes[(id % palettes.length)];
        }


        // ********** BEGUB GAME MECHANICS / MANAGEMENT **********
        var message = document.getElementById("message"),   // Get handle on the message DIV
            timer,                                          // Allows timer to be managed from multiple places
            timerLength = 20;                               // Allows clean management of timer length

        var timerBar = d3.select("#timerBar"),
            timerBarBox = d3.select("#timerBarBox");


        function gameManager(event) {

            switch (event) {
                case "incorrect":
                    message.innerHTML = "<b>There's a problem...</b>";
                    break;
                case "timerBar":
                    timerBar.attr("width", timerLength > 0 ? timerLength * 2 : 0).attr("opacity", (timerLength > 10 ? 0.5 : 1));
                    break;
                case "start":
                    timerLength = ~~(allWordData.length * 1.5);
                    clearInterval(timer);
                    timer = setInterval(gameTimer, 1000);
                    timerBar.attr("width", timerLength * 2);
                    timerBarBox.attr("width", timerLength * 2);
                    message.innerHTML = "Click the words in the correct order.";
                    break;
                case "win":
                    message.innerHTML = "<b>You WON! Score = " + timerLength + 1 + "</b>";
                    timerBar.attr("width", 0);
                    clearInterval(timer);
                    break;
                case "loss":
                    message.innerHTML = "I'm sorry for your loss.";
                    clearInterval(timer);
                    break;
                case "restart":
                    clickedID = [];
                    allWordData = [];   // All words (data) from text from json
                    wordData = [];      // Words loaded (data) into simulation from json
                    wordLinks = [];     // Links (data) in the simulation
                    answerKey = [];     // The right answer
                    playerAnswer = [];  //

                    d3.selectAll("g, .link").remove();
                    //start(); // TODO: Use in future to remove nodes / links properly
                    build();
                    break;
                case "sayit":
                    if (window.speechSynthesis.speaking) {
                        window.speechSynthesis.cancel();
                    } else {
                        var msg = new SpeechSynthesisUtterance(text);
                        window.speechSynthesis.speak(msg);
                        message.innerHTML = "[Say It only works in Chrome browser.]";
                    }
                    break;
                case "boldit":
                    boldIt = !boldIt;
                    message.innerHTML = "Bolding: " + (boldIt ? "On" : "Off");
                    gameManager("restart");
                    break;
                case "showit":
                    if (message.innerHTML == text) { message.innerHTML = ""; }
                    else { message.innerHTML = text; }
                    break;
            }
        }


        function gameTimer() {
            if (timerLength-- >= 0) {
                gameManager("timerBar");
            } else {
                gameManager("loss")
                clearInterval(timer);
            }
        }


        // ********** BEGIN TYPER INTERACTION **********
        function typer() {
            var quote = text,
                char = 0;

            $('#typeCitation').text(citation);
            $('#typeText').empty();
            // Type the text
            function updateText() {

                if (char < quote.length) {
                    $('#typeText').append(quote[char++]);
                    setTimeout(updateText, 25);
                } else {
                    hilite();
                    colorMe();
                }
            }

            // Create a list of regular expressions that will be matched and wrapped in hilite().
            var res = ["God"]; //, "[a-z]{6,}"
            quote.split(" ").forEach(function (wd, i) {
                if (Math.round(Math.random() * (wd.length / 5))) {
                    res.push(wd);
                }
            });

            // Decide which words should be highlighted, wrap them with a SPAN with a CLASS of 'color'
            function hilite() {
                $("#typeText").html(function (_, html) {
                    // /([a-z]{6,})([^<])/g --> Any word made up of a-z that is 6 letters or longer,
                    // whose next character is not '<'. Trailing g = global search, i = case-insensitive.
                    // \b = word bourndary, preceded by and escape character \.
                    res.forEach(function (re, i) {
                        html = html.replace(RegExp("(\\b" + re + "\\b)([^<])", 'gi'), '<span class="color">$1</span>$2');
                        // .replace( new RegExp('god', 'i'), '' )
                    });
                    return html;
                });
            }


            var wordColor = colorPalette(text.length),
                word = 1;

            // Color the chosen words
            function colorMe() {
                var selWord = ".color:nth-of-type(#)".replace("#", word++); // Choose the current word
                if ($(selWord).length > 0) {  // Is this a valid selector?
                    $(selWord).css("color", wordColor[Math.ceil(Math.random() * 5 - 1)]);
                    setTimeout(colorMe, 30);
                }
            }

            updateText();
        }
    });
</script>